name: CI

on: [push]

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    container: openjdk:11
    steps:
    - uses: actions/checkout@v2
    - name: Download Apktool wrapper
      run: wget -O /usr/local/bin/apktool https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool
    - name: Download Apktool Jar
      run: wget -O /usr/local/bin/apktool.jar https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.4.1.jar
    - name: Make apktool executable
      run: chmod +x /usr/local/bin/apktool
    - name: Build unsigned apk
      run: apktool b .
    - name: Upload unsigned apk
      if: success()
      uses: actions/upload-artifact@v1
      with:
        name:  i高醫_4.3.3_unsigned.apk
        path:  dist/iKMU_4.3.3.apk
  sign:
    name: Sign
    runs-on: ubuntu-latest
    needs: build
    if: success()
    steps:
      - name: Download unsigned apk
        uses: actions/download-artifact@v1
        with:
          name:  i高醫_4.3.3_unsigned.apk
          path:  dist/i高醫_4.3.3_unsigned.apk
      - name: Sign apk
        id: sign
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: dist/i高醫_4.3.3_unsigned.apk
          signingKeyBase64: ${{ secrets.SIGNING_KEYSTORE }}
          alias: ${{ secrets.SIGNING_ALIAS }}
          keyStorePassword: ${{ secrets.SIGNING_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.SIGNING_KEY_PASSWORD }}
      - name: Rename signed apk
        run: mv ${{steps.sign.outputs.signedReleaseFile}} dist/iKMU_4.3.3.apk
      - name: Upload signed apk
        if: success()
        uses: actions/upload-artifact@v1
        with:
          name:  i高醫_4.3.3.apk
          path:  dist/iKMU_4.3.3.apk
